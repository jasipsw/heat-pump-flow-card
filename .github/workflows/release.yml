name: Create Stable Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type (leave empty to use current version)'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'
      version:
        description: 'Specific version to release (overrides bump_type, leave empty to use bump_type or current version)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Calculate version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Check if specific version is provided
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using manually specified version: $VERSION"
            SHOULD_BUMP=true
          # Check if bump_type is provided and not 'none'
          elif [ "${{ inputs.bump_type }}" != "none" ] && [ -n "${{ inputs.bump_type }}" ]; then
            # Parse current version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

            case "${{ inputs.bump_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                echo "Bumping major version"
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                echo "Bumping minor version"
                ;;
              patch)
                PATCH=$((PATCH + 1))
                echo "Bumping patch version"
                ;;
            esac

            VERSION="$MAJOR.$MINOR.$PATCH"
            echo "Calculated new version: $VERSION"
            SHOULD_BUMP=true
          else
            VERSION="$CURRENT_VERSION"
            echo "Using current version from package.json: $VERSION"
            SHOULD_BUMP=false
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should_bump=$SHOULD_BUMP" >> $GITHUB_OUTPUT

      - name: Update version in files
        if: steps.version.outputs.should_bump == 'true'
        run: |
          echo "Updating version to ${{ steps.version.outputs.version }}"

          # Update package.json
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version

          # Update const.ts
          sed -i "s/CARD_VERSION = '.*'/CARD_VERSION = '${{ steps.version.outputs.version }}'/" src/const.ts

          # Update hacs.json
          if grep -q '"version"' hacs.json; then
            sed -i "s/\"version\": \".*\"/\"version\": \"${{ steps.version.outputs.version }}\"/" hacs.json
          else
            sed -i "/\"name\":/a\  \"version\": \"${{ steps.version.outputs.version }}\"," hacs.json
          fi

          echo "Version files updated"

      - name: Build project
        if: steps.version.outputs.should_bump == 'true'
        run: |
          npm ci
          npm run build

      - name: Commit version bump
        if: steps.version.outputs.should_bump == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json package-lock.json src/const.ts hacs.json
          git add -f dist/ *.js *.map
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} for stable release" || echo "No changes to commit"
          git push

      - name: Verify build files
        run: |
          echo "Verifying release files exist..."
          ls -lh heat-pump-flow-card.js heat-pump-flow-card.js.map
          echo "✓ Build files verified"

      - name: Check if version tag exists
        id: check_tag
        run: |
          # Fetch latest tags after potential push
          git fetch --tags
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} does not exist"
          fi

      - name: Create Stable Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Heat Pump Flow Card v${{ steps.version.outputs.version }} - Stable Release

            ✅ **This is a stable release ready for production use.**

            ### Installation

            This release is compatible with HACS. The card will be automatically updated if you installed it through HACS.

            For manual installation:
            1. Download `heat-pump-flow-card.js` from the assets below
            2. Copy it to your `config/www` folder
            3. Add the resource in your Lovelace configuration

            ### Changes

            See the [commit history](https://github.com/jasipsw/heat-pump-flow-card/commits/v${{ steps.version.outputs.version }}) for detailed changes.

            ### Full Documentation

            For configuration options and examples, see the [README](https://github.com/jasipsw/heat-pump-flow-card/blob/main/README.md).
          files: |
            heat-pump-flow-card.js
            heat-pump-flow-card.js.map
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Update Pre-Release to Stable
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "::notice::Tag v${{ steps.version.outputs.version }} already exists. Promoting pre-release to stable."
          gh release edit v${{ steps.version.outputs.version }} --prerelease=false --latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

