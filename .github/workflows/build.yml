name: Build and Commit JS Files

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'rollup.config.js'
      - 'tsconfig.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history for proper rebasing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Rename artifacts for refactor branch
        if: github.ref == 'refs/heads/refactor/css-pipe-animation'
        run: |
          if [ -f dist/heat-pump-flow-card.js ]; then
            mv dist/heat-pump-flow-card.js dist/heat-pump-flow-card-next.js
            echo "Renamed heat-pump-flow-card.js to heat-pump-flow-card-next.js"
          fi
          if [ -f dist/heat-pump-flow-card.js.map ]; then
            mv dist/heat-pump-flow-card.js.map dist/heat-pump-flow-card-next.js.map
            echo "Renamed heat-pump-flow-card.js.map to heat-pump-flow-card-next.js.map"
          fi

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet dist/ heat-pump-flow-card.js heat-pump-flow-card.js.map || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Fetch latest and commit built files
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Stash the built files (force add since they're in .gitignore)
          git add -f dist/*.js dist/*.map heat-pump-flow-card.js heat-pump-flow-card.js.map
          git stash push -m "Built files"

          # Fetch and rebase on latest remote changes
          git fetch origin ${{ github.ref_name }}
          git rebase origin/${{ github.ref_name }} || {
            # If rebase fails (conflicts), abort and use theirs, then apply our builds
            git rebase --abort
            git reset --hard origin/${{ github.ref_name }}
          }

          # Apply the built files (will overwrite, force add since they're in .gitignore)
          git stash pop || true
          git add -f dist/*.js dist/*.map heat-pump-flow-card.js heat-pump-flow-card.js.map
          git commit -m "Auto-build: Update compiled JS files [skip ci]" || {
            echo "No changes to commit after rebase"
            exit 0
          }

      - name: Push changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          # Push with force-with-lease to safely overwrite only if no one else pushed
          git push origin HEAD:${{ github.ref_name }} --force-with-lease
